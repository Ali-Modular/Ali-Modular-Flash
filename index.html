<meta name="theme-color" content="#ea4a34">
  <style>
    :root{
      /* Brand */
      --brand:#ea4a34;           /* pulled from your logo */
      --brand-ink:#ffffff;
      /* UI */
      --bg:#0a0b0d; --bg-soft:#0e1117;
      --fg:#e7edf3; --muted:#aab6c3;
      --line:#1b2330; --card:#11161f; --card-ink:#dfe7ef;
      --ok:#33d17a; --warn:#f5c451; --err:#ff6b6b;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
@@ -24,14 +22,12 @@
      font:16px/1.45 system-ui,-apple-system,"Segoe UI",Inter,Roboto,Arial,sans-serif}
    a{color:var(--brand);text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    /* Header */
    header{display:flex;align-items:center;justify-content:space-between;padding:16px 0}
    .logo{display:flex;align-items:center;gap:14px}
    .logo img{height:42px;width:auto;display:block}
    .logo h1{font-size:1.35rem;margin:0;letter-spacing:.2px}
    nav a{margin-left:18px;opacity:.9}
    nav a:hover{opacity:1}
    /* Hero */
    .hero{display:grid;grid-template-columns:1.2fr .8fr;gap:22px;align-items:center;margin-top:8px}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .hero-card{padding:28px}
@@ -46,7 +42,6 @@
    .btn.ghost{background:transparent;color:var(--fg)}
    .env{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px dashed var(--line);background:rgba(255,255,255,.02)}
    .muted{color:var(--muted)}
    /* Two-column body */
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:22px;margin-top:22px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    h3{margin:.2rem 0 1rem 0;font-size:1.15rem}
@@ -57,40 +52,26 @@
    details{background:#0f141c;border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:10px}
    details summary{cursor:pointer;font-weight:600}
    ul.notes{margin:.5rem 0 0 0;padding-left:18px}
    /* Console */
    .console{padding:0}
    .console h3{padding:18px 18px 0 18px}
    pre#log{margin:12px;border-top:1px solid var(--line);padding:14px 18px;height:320px;overflow:auto;
      background:var(--bg-soft);border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius)}
    /* How-to / Troubleshoot */
    .stack{display:grid;grid-template-columns:1fr 1fr;gap:22px;margin-top:22px}
    ol{margin:0;padding-left:18px}
    /* Footer */
    footer{margin:26px 0;color:var(--muted);font-size:.9rem}
    /* Responsive */
    @media (max-width: 980px){
      .hero{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .stack{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header>
      <div class="logo">
        <img src="./assets/Ali-Modular_Color-Alt-Transparent.png" alt="Ali Modular logo" />
        <h1>Ali Modular — Firmware Updater</h1>
      </div>
      <nav>
        <a href="#howto">How-To</a>
        <a href="#troubleshoot">Troubleshoot</a>
        <a href="https://alimodular.com" target="_blank" rel="noopener">alimodular.com</a>
      </nav>
    </header>

    <!-- Hero -->
    <section class="hero">
      <div class="panel hero-card">
        <span class="badge">DFU (Daisy Seed) via WebUSB</span>
@@ -108,9 +89,9 @@ <h2>Update your Esu’s Trifecta firmware</h2>
        <h3>Firmware</h3>
        <div class="row">
          <label for="channel">Channel</label>
          <select id="channel" aria-label="Firmware channel"></select>
          <label for="version">Version</label>
          <select id="version" aria-label="Firmware version"></select>
        </div>
        <details open>
          <summary>Release notes</summary>
@@ -130,189 +111,19 @@ <h3>Manual file</h3>
      </div>
    </section>

    <!-- Body: Console + Guides -->
    <section class="grid">
      <div class="card console">
        <h3>Console</h3>
        <pre id="log" aria-live="polite"></pre>
      </div>

      <div>
        <div id="howto" class="card">
          <h3>How-To</h3>
          <ol>
            <li>Enter DFU: hold <b>BOOT</b>, tap <b>RESET</b>, release RESET, then BOOT.</li>
            <li>Click <b>Connect Device</b> → select <b>DFU in FS Mode</b>.</li>
            <li>Pick a version → <b>Flash Selected</b>. Keep USB connected.</li>
            <li>When finished, power-cycle the module.</li>
          </ol>
        </div>

        <div id="troubleshoot" class="card" style="margin-top:22px">
          <h3>Troubleshoot</h3>
          <ul>
            <li><b>Windows:</b> If the device doesn’t connect, install <i>WinUSB</i> for “DFU in FS Mode” using Zadig, then reconnect.</li>
            <li><b>Browser:</b> Use Chrome/Edge over HTTPS. Safari/Firefox don’t support WebUSB.</li>
            <li><b>USB:</b> Use a direct port and a data-capable cable (no hubs).</li>
            <li><b>Stuck in DFU?</b> Power-cycle and retry.</li>
          </ul>
        </div>
      </div>
    </section>

    <footer>
      © 2025 Ali Modular · Flashing happens locally in your browser with WebUSB DFU.
    </footer>
  </div>

  <!-- WebDFU library (browser global "dfu") -->
  <script src="https://unpkg.com/webdfu@0.1.7/dist/webdfu.min.js" defer></script>

  <script>
  (function () {
    const $ = (sel) => document.querySelector(sel);
    const logEl = $("#log");
    function log(msg){ const ts=new Date().toLocaleTimeString(); logEl.textContent += "["+ts+"] "+msg+"\\n"; logEl.scrollTop = logEl.scrollHeight; }

    const envEl=$("#env"), connectBtn=$("#connectBtn"), deviceInfo=$("#deviceInfo");
    const channelSel=$("#channel"), versionSel=$("#version"), refreshBtn=$("#refreshBtn");
    const notesUl=$("#notes"), flashBtn=$("#flashBtn");
    const fileInput=$("#fileInput"), flashFileBtn=$("#flashFileBtn");
    const progressText=$("#progressText");

    const supportsWebUSB = !!navigator.usb;
    envEl.textContent = supportsWebUSB
      ? "✅ WebUSB available (Chrome or Edge over HTTPS)."
      : "⚠️ WebUSB not available. Use Chrome/Edge on desktop over HTTPS.";

    window.addEventListener("load", () => {
      if (!window.dfu) { envEl.innerHTML = "❌ <b>webdfu</b> failed to load. Check network/HTTPS."; log("webdfu not loaded."); }
    });

    // Manifest
    let manifest = null;
    async function loadManifest() {
      try {
        const res = await fetch("./manifest.json", { cache: "no-store" });
        if (!res.ok) throw new Error("manifest.json not found ("+res.status+")");
        manifest = await res.json();

        // Populate channels
        channelSel.innerHTML = "";
        const chDefault = manifest.default_channel || "stable";
        Object.keys(manifest.channels||{}).forEach(ch=>{
          const opt=document.createElement("option");
          opt.value=ch; opt.textContent=ch;
          if (ch===chDefault) opt.selected=true;
          channelSel.appendChild(opt);
        });
        populateVersions();
        log("Manifest loaded.");
      } catch (e) {
        log("ERROR: "+e.message+" — Ensure manifest.json is beside index.html.");
      }
    }
    function populateVersions() {
      versionSel.innerHTML = "";
      const ch = channelSel.value;
      const list = (manifest.channels && manifest.channels[ch]) || [];
      list.forEach((fw, idx)=>{
        const opt = document.createElement("option");
        opt.value = idx;
        opt.textContent = fw.version + (fw.notes && fw.notes[0] ? " — "+fw.notes[0] : "");
        versionSel.appendChild(opt);
      });
      updateNotes();
    }
    function updateNotes() {
      notesUl.innerHTML = "";
      const ch = channelSel.value;
      const idx = parseInt(versionSel.value || "0", 10);
      const fw = ((manifest.channels||{})[ch]||[])[idx];
      if (!fw) return;
      (fw.notes||[]).forEach(n=>{
        const li=document.createElement("li"); li.textContent=n; notesUl.appendChild(li);
      });
    }
    channelSel.addEventListener("change", populateVersions);
    versionSel.addEventListener("change", updateNotes);
    refreshBtn.addEventListener("click", loadManifest);

    // DFU plumbing
    let usbDevice=null, dfuDevice=null;

    connectBtn.addEventListener("click", async ()=>{
      try{
        if (!window.dfu) throw new Error("webdfu not loaded");
        const filters = [{ vendorId: 0x0483 }]; // STMicro (0483:DF11 common for Daisy DFU)
        usbDevice = await navigator.usb.requestDevice({ filters });
        await usbDevice.open();

        dfuDevice = await dfu.findDevice(usbDevice);
        if (!dfuDevice) throw new Error("DFU interface not found. Is the device in DFU mode?");
        await dfuDevice.open();

        const info = await dfuDevice.getInfo();
        deviceInfo.textContent = "Connected: " + (usbDevice.productName || "USB Device") +
          " (Transfer Size " + info.transferSize + " bytes)";
        log("Connected " + (usbDevice.productName||"") + " — DFU alts: " + dfuDevice.interfaces.map(i=>i.name).join(", "));
        flashBtn.disabled=false;
        flashFileBtn.disabled = !fileInput.files?.length ? true : false;
      }catch(e){ log("ERROR connecting: "+e.message); }
    });

    async function flashArrayBuffer(buf){
      if (!dfuDevice) throw new Error("No DFU device");
      progressText.textContent="Preparing...";
      const data=new Uint8Array(buf);
      const intf = dfuDevice.interfaces[0];
      await dfuDevice.claimInterface(intf.interfaceNumber);
      await dfuDevice.selectAlternate(intf.interfaceNumber, 0);
      const xfer=(written,total)=>{ const pct=Math.floor((written/total)*100);
        progressText.textContent="Writing "+pct+"% ("+written+"/"+total+")"; };

      await dfuDevice.download(0, data, xfer);
      progressText.textContent="Finalizing...";
      await dfuDevice.manifest();
      progressText.textContent="Done. If the device doesn't reboot, power-cycle it.";
      log("Flash complete.");
    }

    flashBtn.addEventListener("click", async ()=>{
      try{
        if (!manifest) throw new Error("Manifest not loaded");
        const ch = channelSel.value;
        const idx = parseInt(versionSel.value||"0",10);
        const fw = ((manifest.channels||{})[ch]||[])[idx];
        if (!fw) throw new Error("No firmware selected");

        log("Downloading "+fw.file+" ...");
        const res = await fetch("./"+fw.file, { cache: "no-store" });
        if (!res.ok) throw new Error("Firmware file not found ("+res.status+")");
        const buf = await res.arrayBuffer();

        if (fw.sha256){
          const hash=await crypto.subtle.digest("SHA-256", buf);
          const hex=Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
          if (hex.toLowerCase() !== fw.sha256.toLowerCase()) throw new Error("Checksum mismatch. Download may be corrupted.");
          log("Checksum OK.");
        }
        await flashArrayBuffer(buf);
      }catch(e){ progressText.textContent=""; log("ERROR flashing: "+e.message); }
    });

    fileInput.addEventListener("change",()=>{ flashFileBtn.disabled = !fileInput.files?.length || !dfuDevice; });
    flashFileBtn.addEventListener("click", async ()=>{
      try{
        const f=fileInput.files?.[0]; if(!f) return;
        log("Reading "+f.name+" ...");
        const buf=await f.arrayBuffer();
        await flashArrayBuffer(buf);
      }catch(e){ progressText.textContent=""; log("ERROR flashing file: "+e.message); }
    });

    loadManifest();
  })();
  </script>
</body>
</html>
